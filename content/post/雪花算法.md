---
title: "雪花算法"
date: 2024-03-29T16:16:02+08:00
Description: ""
Tags: ["雪花算法","分布式"]
Categories: ["算法"]
DisableComments: false
---

# 基本介绍

1. 分布式 ID 生成算法用于在分布式系统中生成全局唯一的 ID 标识
2. 雪花是二进制的 64位（只有 63 位用于填充有符号整数），最终数字一般以十进制序列化
3. Twitter 提出的雪花算法便是其中一种知名的算法，也是一种发号器方案


## 特征

1. 全局唯一性，可保证集群系统生成的ID全局唯一
2. 趋势递增，由于强依赖于时间戳，所以整体趋势是递增的
3. 不满足单调递增，不考虑时间回拨的情况下，单机是单调递增，但是整个集群是趋势递增

## 原理

用64位长整型二进制表示，不同位代表不同意义
1. 1bit保留，最高位为符号位，1表示负数，0表示正数，最高位固定为0
2. 41bit时间戳，这里采用时间戳，单位为毫秒，实际操作中可以用当前时间戳减去一个固定的开始时间戳，这样可增加可使用时间长度
3. 10bit机器id，上限为1024
4. 12bit序列，用于在同一毫秒内生成id，同一毫秒内递增，上限为4096


![snowflake](../images/snowflake-1.png)


# 时间回拨问题

由于雪花算法强依赖于机器时间，当时间发生回拨时，就有可能导致生成的id重复。

## 产生的原因

1. 负[闰秒](https://zh.wikipedia.org/zh-sg/%E9%97%B0%E7%A7%92)（国际度量衡大会通过决议 最晚2035年取消闰秒）
2. 网络时间校准
3. 人工修改

## 解决方案

1. 直接抛出异常，由业务系统决定如何处理（过于粗暴）
2. 延迟等待，阻塞几毫秒，再判断时间戳是否比上次大，如果大了说明正常，否则说明问题较大，可执行方案1的抛出异常



